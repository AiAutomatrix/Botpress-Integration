"use strict";var ge=Object.create;var P=Object.defineProperty;var le=Object.getOwnPropertyDescriptor;var ce=Object.getOwnPropertyNames;var pe=Object.getPrototypeOf,de=Object.prototype.hasOwnProperty;var A=(t,e)=>{for(var n in e)P(t,n,{get:e[n],enumerable:!0})},E=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ce(e))!de.call(t,s)&&s!==n&&P(t,s,{get:()=>e[s],enumerable:!(r=le(e,s))||r.enumerable});return t},l=(t,e,n)=>(E(t,e,"default"),n&&E(n,e,"default")),_=(t,e,n)=>(n=t!=null?ge(pe(t)):{},E(e||!t||!t.__esModule?P(n,"default",{value:t,enumerable:!0}):n,t)),ue=t=>E(P({},"__esModule",{value:!0}),t);var T={};A(T,{Bot:()=>U,BotSpecificClient:()=>b,Integration:()=>M,IntegrationDefinition:()=>y,IntegrationSpecificClient:()=>I,RuntimeError:()=>D.RuntimeError,botIdHeader:()=>v,botUserIdHeader:()=>F,configurationHeader:()=>C,integrationIdHeader:()=>O,isApiError:()=>D.isApiError,messages:()=>k,operationHeader:()=>x,parseBody:()=>u,serve:()=>S,studioComponentDefinitions:()=>K,typeHeader:()=>R,webhookIdHeader:()=>H});module.exports=ue(T);var k={};A(k,{defaults:()=>Ie});var a={};A(a,{default:()=>Te,studioComponentDefinitions:()=>K});var o=require("@bpinternal/zui");l(a,require("@bpinternal/zui"));var d=o.z.object({allowDynamicVariable:o.z.boolean().optional(),horizontal:o.z.boolean().optional()}),K={string:{text:{id:"text",params:d.extend({multiLine:o.z.boolean().optional(),growVertically:o.z.boolean().optional(),suggestions:o.z.array(o.z.string()).optional()})},dropdown:{id:"dropdown",params:d.extend({filterable:o.z.boolean().optional()})},radiogroup:{id:"radiogroup",params:d.extend({})},date:{id:"date",params:d.extend({dateFormat:o.z.string().optional(),minDate:o.z.string().optional(),maxDate:o.z.string().optional(),defaultTimezone:o.z.string().optional(),disableTimezoneSelection:o.z.boolean().optional(),highlightCurrentDay:o.z.boolean().optional(),showShortcutButtons:o.z.boolean().optional(),showOutsideDaysOfMonth:o.z.boolean().optional(),firstDayOfWeek:o.z.number().optional(),canChangeMonth:o.z.boolean().optional(),showWeekNumbers:o.z.boolean().optional()})},time:{id:"time",params:d.extend({useAMPM:o.z.boolean().optional(),timeFormat:o.z.string().optional(),minTime:o.z.string().optional(),maxTime:o.z.string().optional(),showArrowButtons:o.z.boolean().optional(),precision:o.z.enum(["minute","second","millisecond"]).optional()})},richtext:{id:"richtext",params:o.z.object({allowDynamicVariable:o.z.boolean().optional(),resizable:o.z.boolean().optional()})},json:{id:"json",params:d.extend({showPreview:o.z.boolean().optional(),showValidationError:o.z.boolean().optional()})},file:{id:"file",params:d.extend({fileTypes:o.z.array(o.z.enum(["image","audio","video"])).optional(),showUploadedFiles:o.z.boolean().optional()})}},number:{number:{id:"number",params:d.extend({allowNumericCharactersOnly:o.z.boolean().optional(),stepSize:o.z.number().optional()})},slider:{id:"slider",params:o.z.object({horizontal:o.z.boolean().optional(),stepSize:o.z.number().optional()})}},boolean:{switch:{id:"switch",params:d}},array:{options:{id:"options",params:d},strings:{id:"strings",params:d},daterange:{id:"daterange",params:o.z.object({dateFormat:o.z.string().optional(),minDate:o.z.string().optional(),maxDate:o.z.string().optional(),defaultTimezone:o.z.string().optional(),allowSingleDayRange:o.z.boolean().optional(),highlightCurrentDay:o.z.boolean().optional(),showOutsideDaysOfMonth:o.z.boolean().optional(),firstDayOfWeek:o.z.number().optional(),canChangeMonth:o.z.boolean().optional(),showWeekNumbers:o.z.boolean().optional()})}},object:{collapsible:{id:"collapsible",params:o.z.object({defaultOpen:o.z.boolean().optional()})},modal:{id:"modal",params:o.z.object({title:o.z.string().optional(),buttonLabel:o.z.string().optional(),closeButtonLabel:o.z.string().optional()})},popover:{id:"popover",params:o.z.object({buttonLabel:o.z.string().optional()})}},discriminatedUnion:{}},Te=o.z;var c=a.z.string().min(1),z=a.z.object({text:c}),N=a.z.object({markdown:c}),W=a.z.object({imageUrl:c}),$=a.z.object({audioUrl:c}),Z=a.z.object({videoUrl:c}),J=a.z.object({fileUrl:c,title:c.optional()}),V=a.z.object({latitude:a.z.number(),longitude:a.z.number(),address:a.z.string().optional(),title:a.z.string().optional()}),Q=a.z.object({title:c,subtitle:c.optional(),imageUrl:c.optional(),actions:a.z.array(a.z.object({action:a.z.enum(["postback","url","say"]),label:c,value:c}))}),q=a.z.object({text:c,options:a.z.array(a.z.object({label:c,value:c}))}),me=a.z.object({items:a.z.array(Q)}),he=a.z.discriminatedUnion("type",[a.z.object({type:a.z.literal("text"),payload:z}),a.z.object({type:a.z.literal("markdown"),payload:N}),a.z.object({type:a.z.literal("image"),payload:W}),a.z.object({type:a.z.literal("audio"),payload:$}),a.z.object({type:a.z.literal("video"),payload:Z}),a.z.object({type:a.z.literal("file"),payload:J}),a.z.object({type:a.z.literal("location"),payload:V})]),ye=a.z.object({items:a.z.array(he)}),Ie={text:{schema:z},markdown:{schema:N},image:{schema:W},audio:{schema:$},video:{schema:Z},file:{schema:J},location:{schema:V},carousel:{schema:me},card:{schema:Q},dropdown:{schema:q},choice:{schema:q},bloc:{schema:ye}};var v="x-bot-id",F="x-bot-user-id",O="x-integration-id",H="x-webhook-id",C="x-bp-configuration",x="x-bp-operation",R="x-bp-type";var X=require("node:http");var h=console;function u(t){if(!t.body)throw new Error("Missing body");return JSON.parse(t.body)}async function S(t,e=8072,n=ve){let r=(0,X.createServer)(async(s,i)=>{try{let g=await fe(s);if(g.path==="/health"){i.writeHead(200).end("ok");return}let p=await t(g);i.writeHead(p?.status??200,p?.headers??{}).end(p?.body??"{}")}catch(g){h.error("Error while handling request",{error:g?.message??"Internal error occured"}),i.writeHead(500).end(JSON.stringify({error:g?.message??"Internal error occured"}))}});return r.listen(e,()=>n(e)),r}async function fe(t){let e=await Be(t),n={};for(let s=0;s<t.rawHeaders.length;s+=2){let i=t.rawHeaders[s].toLowerCase(),g=t.rawHeaders[s+1];n[i]=g}let r=new URL(t.url??"",t.headers.host?`http://${t.headers.host}`:"http://botpress.cloud");return{body:e,path:r.pathname,query:be(r.search,"?"),headers:n,method:t.method?.toUpperCase()??"GET"}}function be(t,e){return t.indexOf(e)===0?t.slice(e.length):t}async function Be(t){return new Promise((e,n)=>{if(t.method!=="POST"&&t.method!=="PUT"&&t.method!=="PATCH")return e(void 0);let r="";t.on("data",s=>r+=s.toString()),t.on("error",s=>n(s)),t.on("end",()=>e(r))})}function ve(t){h.info(`Listening on port ${t}`)}l(T,a,module.exports);var D=require("@botpress/client");var Y=require("@bpinternal/zui");var Ce=Y.z.enum(["webhook_received","message_created","action_triggered","register","unregister","ping","create_user","create_conversation"]),ee=t=>{let e=t[v],n=t[F],r=t[O],s=t[H],i=t[C],g=Ce.parse(t[x]);if(!e)throw new Error("Missing bot headers");if(!n)throw new Error("Missing bot user headers");if(!r)throw new Error("Missing integration headers");if(!s)throw new Error("Missing webhook headers");if(!i)throw new Error("Missing configuration headers");if(!g)throw new Error("Missing operation headers");return{botId:e,botUserId:n,integrationId:r,webhookId:s,operation:g,configuration:i?JSON.parse(Buffer.from(i,"base64").toString("utf-8")):{}}};var y=class{constructor(e){this.props=e;this.name=e.name,this.version=e.version,this.icon=e.icon,this.readme=e.readme,this.title=e.title,this.identifier=e.identifier,this.description=e.description,this.configuration=e.configuration,this.events=e.events,this.actions=e.actions,this.channels=e.channels,this.states=e.states,this.user=e.user,this.secrets=e.secrets,this.entities=e.entities}name;version;title;description;icon;readme;configuration;events;actions;channels;states;user;secrets;identifier;entities;clone(e){return new y({...this,...e})}};var f=require("@botpress/client");var I=class{constructor(e){this.client=e}createConversation=e=>this.client.createConversation(e);getConversation=e=>this.client.getConversation(e);listConversations=e=>this.client.listConversations(e);getOrCreateConversation=e=>this.client.getOrCreateConversation(e);updateConversation=e=>this.client.updateConversation(e);deleteConversation=e=>this.client.deleteConversation(e);listParticipants=e=>this.client.listParticipants(e);addParticipant=e=>this.client.addParticipant(e);getParticipant=e=>this.client.getParticipant(e);removeParticipant=e=>this.client.removeParticipant(e);createEvent=e=>this.client.createEvent(e);getEvent=e=>this.client.getEvent(e);listEvents=e=>this.client.listEvents(e);createMessage=e=>this.client.createMessage(e);getOrCreateMessage=e=>this.client.getOrCreateMessage(e);getMessage=e=>this.client.getMessage(e);updateMessage=e=>this.client.updateMessage(e);listMessages=e=>this.client.listMessages(e);deleteMessage=e=>this.client.deleteMessage(e);createUser=e=>this.client.createUser(e);getUser=e=>this.client.getUser(e);listUsers=e=>this.client.listUsers(e);getOrCreateUser=e=>this.client.getOrCreateUser(e);updateUser=e=>this.client.updateUser(e);deleteUser=e=>this.client.deleteUser(e);getState=e=>this.client.getState(e);setState=e=>this.client.setState(e);getOrSetState=e=>this.client.getOrSetState(e);patchState=e=>this.client.patchState(e);configureIntegration=e=>this.client.configureIntegration(e);uploadFile=e=>this.client.uploadFile(e);upsertFile=e=>this.client.upsertFile(e);deleteFile=e=>this.client.deleteFile(e);listFiles=e=>this.client.listFiles(e);getFile=e=>this.client.getFile(e);updateFileMetadata=e=>this.client.updateFileMetadata(e)};var j=_(require("util")),w=t=>{if(process.env.BP_LOG_FORMAT==="json")return JSON.stringify({msg:j.default.format(...t),visible_to_bot_owner:!0});{let[e,...n]=t;return j.default.format(`[For Bot Owner] ${e}`,...n)}},te={forBot:()=>({info:(...t)=>{console.info(w(t))},warn:(...t)=>{console.warn(w(t))},error:(...t)=>{console.error(w(t))},debug:(...t)=>{console.debug(w(t))}})};var ne=t=>async e=>{let n=ee(e.headers),r=new I(new f.Client({botId:n.botId,integrationId:n.integrationId})),s={ctx:n,req:e,client:r,logger:te,instance:t};try{let i;switch(n.operation){case"webhook_received":i=await Se(s);break;case"register":i=await Ee(s);break;case"unregister":i=await Pe(s);break;case"message_created":i=await Ue(s);break;case"action_triggered":i=await De(s);break;case"ping":i=await xe(s);break;case"create_user":i=await we(s);break;case"create_conversation":i=await Me(s);break;default:throw new Error(`Unknown operation ${n.operation}`)}return i?{...i,status:i.status??200}:{status:200}}catch(i){if((0,f.isApiError)(i)){let g=new f.RuntimeError(i.message,i);return{status:g.code,body:JSON.stringify(g.toJSON())}}throw i}},xe=async t=>{},Se=async({client:t,ctx:e,req:n,logger:r,instance:s})=>{let{req:i}=u(n);return s.webhook({client:t,ctx:e,req:i,logger:r})},Ee=async({client:t,ctx:e,req:n,logger:r,instance:s})=>{if(!s.register)return;let{webhookUrl:i}=u(n);await s.register({client:t,ctx:e,webhookUrl:i,logger:r})},Pe=async({client:t,ctx:e,req:n,logger:r,instance:s})=>{if(!s.unregister)return;let{webhookUrl:i}=u(n);await s.unregister({ctx:e,webhookUrl:i,client:t,logger:r})},we=async({client:t,ctx:e,req:n,logger:r,instance:s})=>{if(!s.createUser)return;let{tags:i}=u(n);return await s.createUser({ctx:e,client:t,tags:i,logger:r})},Me=async({client:t,ctx:e,req:n,logger:r,instance:s})=>{if(!s.createConversation)return;let{channel:i,tags:g}=u(n);return await s.createConversation({ctx:e,client:t,channel:i,tags:g,logger:r})},Ue=async({ctx:t,req:e,client:n,logger:r,instance:s})=>{let{conversation:i,user:g,type:p,payload:B,message:m}=u(e),G=s.channels[i.channel];if(!G)throw new Error(`Channel ${i.channel} not found`);let L=G.messages[p];if(!L)throw new Error(`Message of type ${p} not found in channel ${i.channel}`);await L({ctx:t,conversation:i,message:m,user:g,type:p,client:n,payload:B,ack:async({tags:re})=>{await n.updateMessage({id:m.id,tags:re})},logger:r})},De=async({req:t,ctx:e,client:n,logger:r,instance:s})=>{let{input:i,type:g}=u(t);if(!g)throw new Error("Missing action type");let p=s.actions[g];if(!p)throw new Error(`Action ${g} not found`);let B=await p({ctx:e,input:i,client:n,type:g,logger:r});return{body:JSON.stringify({output:B})}};var M=class{props;actions;channels;register;unregister;createUser;createConversation;webhook;constructor(e){this.props=e,this.actions=e.actions,this.channels=e.channels,this.register=e.register,this.unregister=e.unregister,this.createUser=e.createUser,this.createConversation=e.createConversation,this.webhook=e.handler}handler=ne(this);start=e=>S(this.handler,e)};var ae=_(require("@botpress/client"));var b=class{constructor(e){this.client=e}getConversation=e=>this.client.getConversation(e);listConversations=e=>this.client.listConversations(e);updateConversation=e=>this.client.updateConversation(e);deleteConversation=e=>this.client.deleteConversation(e);listParticipants=e=>this.client.listParticipants(e);addParticipant=e=>this.client.addParticipant(e);getParticipant=e=>this.client.getParticipant(e);removeParticipant=e=>this.client.removeParticipant(e);getEvent=e=>this.client.getEvent(e);listEvents=e=>this.client.listEvents(e);createMessage=e=>this.client.createMessage(e);getOrCreateMessage=e=>this.client.getOrCreateMessage(e);getMessage=e=>this.client.getMessage(e);updateMessage=e=>this.client.updateMessage(e);listMessages=e=>this.client.listMessages(e);deleteMessage=e=>this.client.deleteMessage(e);getUser=e=>this.client.getUser(e);listUsers=e=>this.client.listUsers(e);updateUser=e=>this.client.updateUser(e);deleteUser=e=>this.client.deleteUser(e);getState=e=>this.client.getState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));setState=e=>this.client.setState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));getOrSetState=e=>this.client.getOrSetState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));patchState=e=>this.client.patchState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));callAction=e=>this.client.callAction(e);uploadFile=e=>this.client.uploadFile(e);upsertFile=e=>this.client.upsertFile(e);deleteFile=e=>this.client.deleteFile(e);listFiles=e=>this.client.listFiles(e);getFile=e=>this.client.getFile(e);updateFileMetadata=e=>this.client.updateFileMetadata(e);searchFiles=e=>this.client.searchFiles(e);createConversation=e=>this.client.createConversation(e);getOrCreateConversation=e=>this.client.getOrCreateConversation(e);createUser=e=>this.client.createUser(e);getOrCreateUser=e=>this.client.getOrCreateUser(e)};var oe=require("@bpinternal/zui");var Ae=oe.z.enum(["event_received","register","unregister","ping","action_triggered"]),se=t=>{let e=t[v],n=t[C],r=t[R],s=Ae.parse(t[x]);if(!e)throw new Error("Missing bot headers");if(!r)throw new Error("Missing type headers");if(!n)throw new Error("Missing configuration headers");if(!s)throw new Error("Missing operation headers");return{botId:e,operation:s,type:r,configuration:n?JSON.parse(Buffer.from(n,"base64").toString("utf-8")):{}}};var ie=t=>async e=>{let n=se(e.headers);n.operation!=="ping"&&h.info(`Received ${n.operation} operation for bot ${n.botId} of type ${n.type}`);let r=new b(new ae.Client({botId:n.botId})),s={req:e,ctx:n,client:r,instance:t};switch(n.operation){case"action_triggered":throw new Error(`Operation ${n.operation} not supported yet`);case"event_received":await He(s);break;case"register":await Fe(s);break;case"unregister":await Oe(s);break;case"ping":await ke(s);break;default:throw new Error(`Unknown operation ${n.operation}`)}return{status:200}},ke=async t=>{},Fe=async t=>{},Oe=async t=>{},He=async({ctx:t,req:e,client:n,instance:r})=>{h.debug(`Received event ${t.type}`);let s=u(e),i=s.event;switch(t.type){case"message_created":let g={user:i.payload.user,conversation:i.payload.conversation,message:i.payload.message,states:i.payload.states,event:i};await Promise.all(r.messageHandlers.map(m=>m({client:n,ctx:t,...g})));break;case"state_expired":let p={state:i.payload.state};await Promise.all(r.stateExpiredHandlers.map(m=>m({client:n,ctx:t,...p})));break;default:let B={event:s.event};await Promise.all(r.eventHandlers.map(m=>m({client:n,ctx:t,...B})))}};var U=class{_state={messageHandlers:[],eventHandlers:[],stateExpiredHandlers:[]};props;constructor(e){this.props=e}message=e=>{this._state.messageHandlers.push(e)};event=e=>{this._state.eventHandlers.push(e)};stateExpired=e=>{this._state.stateExpiredHandlers.push(e)};handler=ie(this._state);start=e=>S(this.handler,e)};0&&(module.exports={Bot,BotSpecificClient,Integration,IntegrationDefinition,IntegrationSpecificClient,RuntimeError,botIdHeader,botUserIdHeader,configurationHeader,integrationIdHeader,isApiError,messages,operationHeader,parseBody,serve,studioComponentDefinitions,typeHeader,webhookIdHeader});
//# sourceMappingURL=index.js.map
